---
- name: Check if Pi-hole container is running
  ansible.builtin.command: docker ps --filter "name={{ pihole_container_name }}" --format "{{ '{{' }}.Names{{ '}}' }}"
  register: pihole_status
  changed_when: false
  failed_when: pihole_status.rc != 0

- name: Assert Pi-hole container is running
  ansible.builtin.assert:
    that:
      - pihole_status.stdout_lines | length > 0
    fail_msg: "Pi-hole container is not running."
    success_msg: "Pi-hole container is running."

- name: DNS test for google.com via local Pi-hole
  command: dig +short google.com @127.0.0.1
  register: dns_test_google
  changed_when: false
  failed_when: dns_test_google.stdout == ""

- name: Assert google.com result looks like valid IPv4
  assert:
    that:
      - dns_test_google.stdout_lines | length > 0
      - dns_test_google.stdout_lines | select(
          'match', '^[0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+$'
        ) | list | length > 0
    fail_msg: "DNS did not return at least one valid IPv4 for google.com via Pi-hole:\n{{ dns_test_google.stdout }}"
